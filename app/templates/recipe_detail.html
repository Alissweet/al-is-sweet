{% extends "base.html" %}

{% block title %}{{ recipe.title }} - Al' is Sweet{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- 1. VUE PRINCIPALE : √âpur√©e & Moderne -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Photo Hero Standardis√©e -->
            <div class="recipe-image-wrapper">
                {% if recipe.image_filename %}
					{% if recipe.image_filename.startswith('http') %}
						<img src="{{ recipe.image_filename }}" alt="{{ recipe.title }}" class="recipe-hero-image">
					{% else %}
						<img src="{{ url_for('static', filename='uploads/' + recipe.image_filename) }}" alt="{{ recipe.title }}" class="recipe-hero-image">
					{% endif %}
				{% else %}
					<div class="img-placeholder img-placeholder-hero">
						<div class="img-placeholder-inner">
							<i class="bi bi-egg-fried"></i>
							<span>{{ recipe.category or 'Recette' }}</span>
						</div>
					</div>
				{% endif %}

                <!-- üÜï BOUTON FAVORI INTERACTIF (Haut Gauche) -->
                <button class="btn-favorite-toggle {{ 'active' if recipe.is_favorite else '' }}" 
                        onclick="toggleFavorite({{ recipe.id }}, this)"
                        title="Ajouter aux favoris">
                    <i class="bi {{ 'bi-heart-fill' if recipe.is_favorite else 'bi-heart' }}"></i>
                </button>
                
                <!-- Badge Glucides Flottant (Toujours par dessus) -->
                <div class="badge-carbs" style="top: 20px; right: 20px; font-size: 1rem; padding: 8px 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <i class="bi bi-lightning-fill text-warning"></i>
                    {{ "%.0f"|format(recipe.total_carbs) }}g <span class="fw-light ms-1 small opacity-75">totaux</span>
                </div>
            </div>

            <!-- Titre & Infos -->
            <div class="text-center mb-5">
                <span class="text-uppercase text-muted small ls-2 fw-bold">{{ recipe.category or 'Recette' }}</span>
                <h1 class="recipe-main-title">{{ recipe.title }}</h1>
                
                <!-- M√©ta Donn√©es -->
				<div class="d-flex justify-content-center align-items-center gap-4 text-muted fw-medium flex-wrap">
					<span><i class="bi bi-clock text-terracotta"></i> {{ recipe.total_time }} min</span>
					
					<!-- Contr√¥le portions centralis√© -->
					<div class="servings-control">
						<button class="servings-btn" onclick="adjustServings(-1)" aria-label="Moins">
							<i class="bi bi-dash"></i>
						</button>
						<div class="servings-display">
							<i class="bi bi-people text-terracotta"></i>
							<span id="servingsDisplay">{{ recipe.servings }}</span>
							<span class="servings-unit">pers.</span>
						</div>
						<button class="servings-btn" onclick="adjustServings(1)" aria-label="Plus">
							<i class="bi bi-plus"></i>
						</button>
					</div>

					<span><i class="bi bi-bar-chart text-terracotta"></i> {{ recipe.difficulty }}</span>
				</div>

				<!-- Badge "portions modifi√©es" -->
				<div id="servingsBadge" class="servings-modified-badge d-none mt-2">
					<i class="bi bi-arrow-repeat"></i>
					Recette adapt√©e ‚Äî <span id="servingsRatio"></span>
					<button class="servings-reset-btn" onclick="resetServings()">R√©initialiser</button>
				</div>
                
                {% if recipe.description %}
                <p class="mt-3 text-muted fst-italic">"{{ recipe.description }}"</p>
                {% endif %}
				{% if recipe.tags %}
                <div class="tags-container mt-3 d-flex justify-content-center gap-2 flex-wrap">
                    {% for tag in recipe.tags %}
                    <span class="recipe-tag">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- GRILLE D'ACTION (Le coeur de l'UX) -->
            <div class="action-grid">
                <!-- Bouton Liste de Courses -->
                <button class="btn-action-big btn-shopping" data-bs-toggle="modal" data-bs-target="#shoppingModal">
                    <i class="bi bi-basket3"></i>
                    <span>Liste de courses</span>
                </button>
                
                <!-- Bouton Let's Cook -->
                <button class="btn-action-big btn-cook" onclick="startCooking()">
                    <i class="bi bi-play-circle-fill"></i>
                    <span>Let's Cook !</span>
                </button>
            </div>
			<!-- Bouton Historique -->
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-terracotta rounded-pill" onclick="markAsCooked({{ recipe.id }})">
                    <i class="bi bi-calendar-check me-1"></i> J'ai cuisin√© √ßa aujourd'hui
                </button>
            </div>

            <!-- Actions Admin (Discr√®tes en bas) -->
			<div class="text-center mt-5 pt-4 border-top">
				<a href="#" class="text-muted small me-3 text-decoration-none"
				   data-bs-toggle="modal" data-bs-target="#shareModal">
					<i class="bi bi-share"></i> Partager
				</a>
				<a href="{{ url_for('main.recipe_pdf', id=recipe.id) }}"
				   target="_blank" class="text-muted small me-3 text-decoration-none">
					<i class="bi bi-file-earmark-pdf"></i> PDF
				</a>
				<a href="{{ url_for('main.recipe_edit', id=recipe.id) }}" class="text-muted small me-3 text-decoration-none">
					<i class="bi bi-pencil"></i> Modifier
				</a>
				<a href="#" class="text-danger small text-decoration-none" data-bs-toggle="modal" data-bs-target="#deleteModal">
					<i class="bi bi-trash"></i> Supprimer
				</a>
			</div>

			<!-- WIDGET NOTATION -->
			<div class="rating-widget mt-4">
				<span class="rating-label-top">Mon avis sur cette recette</span>
				<div class="rating-pills">
					{% set labels = ['√Ä revoir', 'Bof‚Ä¶', 'Bien', 'Tr√®s bien', 'Incontournable !'] %}
					{% set emojis = ['üòï', 'üòê', 'üôÇ', 'üòä', 'ü§©'] %}
					{% for i in range(1, 6) %}
					<button class="rating-pill {{ 'active' if recipe.rating == i else '' }}"
							data-value="{{ i }}"
							data-recipe-id="{{ recipe.id }}"
							onclick="rateRecipe(this)">
						<div class="pill-circle">{{ emojis[i-1] }}</div>
						<span class="pill-text">{{ labels[i-1] }}</span>
					</button>
					{% endfor %}
				</div>
				<div class="rating-feedback" id="ratingFeedback">
					{% if recipe.rating %}
						{% set feedbacks = ['', 'Recette √† am√©liorer', 'Recette correcte', 'Bonne recette !', 'Tr√®s bonne recette !', '‚ú® Recette incontournable !'] %}
						{{ feedbacks[recipe.rating] }}
					{% endif %}
				</div>
			</div>

        </div>
    </div>
</div>

<!-- 2. MODALE LISTE DE COURSES -->
<div class="modal fade" id="shoppingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-terracotta text-white">
                <h5 class="modal-title"><i class="bi bi-basket2 me-2"></i>Ingr√©dients</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Calculateur ‚Äî miroir du contr√¥le principal -->
				<div class="d-flex justify-content-between align-items-center mb-4 bg-light p-2 rounded-pill">
					<span class="ms-3 text-muted small">Portions :</span>
					<div class="d-flex align-items-center gap-2">
						<button class="btn btn-sm btn-white rounded-circle shadow-sm" onclick="adjustServings(-1)">
							<i class="bi bi-dash"></i>
						</button>
						<span class="px-3 fw-bold d-flex align-items-center" id="modalServings">{{ recipe.servings }}</span>
						<button class="btn btn-sm btn-white rounded-circle shadow-sm" onclick="adjustServings(1)">
							<i class="bi bi-plus"></i>
						</button>
					</div>
				</div>

                <!-- Liste √† cocher -->
                <div class="list-group list-group-flush">
                    {% for ing in recipe.ingredients %}
                    <label class="list-group-item d-flex gap-3 align-items-center cursor-pointer">
                        <input class="form-check-input flex-shrink-0" type="checkbox" style="width: 1.5em; height: 1.5em;">
                        <span class="ingredient-text" data-base-qty="{{ ing.quantity or 0 }}">
                            <strong class="qty-display">{{ ing.quantity or '' }}</strong> 
                            {{ ing.unit or '' }} {{ ing.name }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer justify-content-center bg-light">
                <small class="text-muted">Cochez les √©l√©ments que vous avez d√©j√† !</small>
            </div>
        </div>
    </div>
</div>

<!-- 3. OVERLAY MODE CUISINE (Cach√© par d√©faut) -->
<div id="cookingMode" class="d-none">
    <!-- Header Cuisine -->
    <div class="cooking-header">
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-fire text-terracotta fs-4"></i>
            <span class="fw-bold text-choco">Mode Cuisine</span>
        </div>
        <button class="btn btn-outline-secondary rounded-pill px-3" onclick="stopCooking()">
            <i class="bi bi-x-lg me-2"></i>Quitter
        </button>
    </div>

    <!-- Barre de progression -->
    <div class="progress-bar-custom">
        <div class="progress-fill" id="cookingProgress"></div>
    </div>

    <!-- Conteneur des √©tapes -->
    <div id="stepsContainer" class="flex-grow-1 d-flex flex-column">
        {% for step in recipe.steps.order_by('order') %}
        <div class="step-slide d-none" data-step="{{ loop.index }}">
            <div class="step-card h-100">
                <div class="step-number-big">√âtape {{ loop.index }}</div>
                <p class="step-instruction-big">{{ step.instruction }}</p>
                {% if step.duration %}
                <div class="mt-4 text-muted">
                    <i class="bi bi-stopwatch fs-3 d-block mb-1"></i>
                    <span class="fs-5">{{ step.duration }} min</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Slide de Fin -->
        <div class="step-slide d-none" data-step="finish">
            <div class="step-card h-100 border-success border-2">
                <div class="step-number-big text-success">Bravo !</div>
                <p class="step-instruction-big">Votre recette est pr√™te √† √™tre d√©gust√©e.</p>
                <i class="bi bi-emoji-heart-eyes display-1 text-warning mt-4"></i>
            </div>
        </div>
    </div>

    <!-- Contr√¥les de Navigation & Astuces -->
    <div class="cooking-controls">
        
        <!-- Wrapper Mobile -->
        <div class="mobile-btn-group d-contents-lg">
            <!-- Bouton Pr√©c√©dent (Cercle/Pilule gris) -->
            <button class="btn btn-outline-secondary btn-lg rounded-pill px-4" 
                    id="prevBtn" onclick="changeStep(-1)" disabled>
                <i class="bi bi-arrow-left"></i>
            </button>
            
            <!-- Bouton Suivant Mobile (M√™me style que Pr√©c√©dent) -->
            <button class="btn btn-outline-secondary btn-lg rounded-pill px-4 d-lg-none" 
                    id="nextBtnMobile" onclick="changeStep(1)">
                <i class="bi bi-arrow-right"></i>
            </button>
        </div>

        <!-- BOITE ASTUCE DU CHEF -->
        {% if recipe.tips %}
        <div class="chef-tip-box">
            <svg class="chef-hat-watermark" viewBox="0 0 24 24">
                <path d="M18,10h-1c-0.55,0-1-0.45-1-1c0-2.76-2.24-5-5-5S6,6.24,6,9c0,0.55-0.45,1-1,1H4c-1.1,0-2,0.9-2,2v7c0,1.1,0.9,2,2,2h16
                c1.1,0,2-0.9,2-2v-7C22,10.9,21.1,10,18,10z M18,4.5c0-0.64-0.31-1.22-0.79-1.6C16.4,2.32,15.25,2,14,2c-0.24,0-0.48,0.01-0.71,0.04
                C12.96,0.84,11.56,0,10,0C7.24,0,5,2.24,5,5c0,0.18,0.01,0.35,0.03,0.52C3.86,6.15,3,7.47,3,9h2C5,6.24,7.24,4,10,4
                c2.41,0,4.43,1.72,4.9,4h1.15C16.54,6.27,18,4.9,18,4.5z"/>
            </svg>
            <div class="chef-tip-title">
                <i class="bi bi-lightbulb-fill"></i> Le conseil du Chef
            </div>
            <p class="chef-tip-text">
                {{ recipe.tips }}
            </p>
        </div>
        {% else %}
        <div></div>
        {% endif %}

        <!-- Bouton Suivant Desktop (M√™me style que Pr√©c√©dent) -->
        <button class="btn btn-outline-secondary btn-lg rounded-pill px-4 d-none d-lg-block" 
                id="nextBtnDesktop" onclick="changeStep(1)">
            <i class="bi bi-arrow-right"></i>
        </button>

    </div>
</div>

<!-- Modal Partage -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-terracotta text-white">
                <h5 class="modal-title"><i class="bi bi-share me-2"></i>Partager la recette</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">

                <!-- √âtat : pas encore de lien -->
                <div id="shareInit">
                    <p class="text-muted mb-3">G√©n√®re un lien public pour partager cette recette, m√™me avec des personnes sans compte.</p>
                    <button class="btn btn-terracotta rounded-pill px-4" onclick="generateShareLink()">
                        <i class="bi bi-link-45deg me-2"></i>G√©n√©rer le lien
                    </button>
                </div>

                <!-- √âtat : lien g√©n√©r√© -->
                <div id="shareResult" class="d-none">
                    <p class="text-muted mb-2">Lien de partage actif :</p>
                    <div class="input-group mb-3">
                        <input type="text" id="shareLinkInput" class="form-control form-control-sm" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyShareLink()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <p id="copyConfirm" class="text-success small d-none">‚úì Lien copi√© !</p>
                    <button class="btn btn-sm btn-outline-danger rounded-pill mt-2" onclick="revokeShareLink()">
                        <i class="bi bi-x-circle me-1"></i>D√©sactiver le lien
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>


<!-- Modal Suppression (Classique) -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <h5 class="mb-3">Supprimer cette recette ?</h5>
                
                <form action="{{ url_for('main.recipe_delete', id=recipe.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-danger">Oui, supprimer</button>
                </form>
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- GESTION DES PORTIONS (LISTE DE COURSES) ---
    const baseServings = {{ recipe.servings }};
    let currentServings = baseServings;

    function adjustServings(delta) {
        let newServings = currentServings + delta;
        if (newServings < 1) return;
        
        currentServings = newServings;
        // Mise √† jour affichage principal et modal
        document.getElementById('servingsDisplay').textContent = currentServings;
        document.getElementById('modalServings').textContent = currentServings;
        
        const ratio = currentServings / baseServings;
        
        // Mise √† jour des quantit√©s dans la liste
        document.querySelectorAll('.ingredient-text').forEach(item => {
            const baseQty = parseFloat(item.dataset.baseQty);
            if (baseQty > 0) {
                const qtyElement = item.querySelector('.qty-display');
                let val = baseQty * ratio;
                // Formatage intelligent (pas de .0)
                qtyElement.textContent = Number.isInteger(val) ? val : val.toFixed(1);
            }
        });
    }

    // --- GESTION DU MODE CUISINE (WIZARD) ---
    let currentStep = 1;
    const totalSteps = {{ recipe.steps.count() }};
    
    function startCooking() {
        document.getElementById('cookingMode').classList.remove('d-none');
        document.body.style.overflow = 'hidden'; // Emp√™che le scroll de la page derri√®re
        showStep(1);
    }

    function stopCooking() {
        document.getElementById('cookingMode').classList.add('d-none');
        document.body.style.overflow = 'auto';
    }

    function showStep(stepIndex) {
        // Masquer toutes les slides
        document.querySelectorAll('.step-slide').forEach(el => el.classList.add('d-none'));
        
        // Afficher la slide courante
        let activeSlide;
        const nextBtns = [document.getElementById('nextBtnDesktop'), document.getElementById('nextBtnMobile')];
        
        if (stepIndex > totalSteps) {
            // √âcran de fin
            activeSlide = document.querySelector('.step-slide[data-step="finish"]');
            
            nextBtns.forEach(btn => {
                if(btn) {
                    // On change juste l'ic√¥ne pour une coche verte
                    btn.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                    btn.onclick = stopCooking;
                    // Optionnel : on peut colorer la bordure en vert pour marquer la fin
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-success');
                }
            });
        } else {
            // √âtape normale
            activeSlide = document.querySelector(`.step-slide[data-step="${stepIndex}"]`);
            
            nextBtns.forEach(btn => {
                if(btn) {
                    // On remet la fl√®che standard
                    btn.innerHTML = '<i class="bi bi-arrow-right"></i>';
                    btn.onclick = () => changeStep(1);
                    // On remet le style gris standard
                    btn.classList.add('btn-outline-secondary');
                    btn.classList.remove('btn-outline-success');
                }
            });
        }
        
        if(activeSlide) activeSlide.classList.remove('d-none');

        // Mise √† jour bouton Pr√©c√©dent
        const prevBtn = document.getElementById('prevBtn');
        if(prevBtn) prevBtn.disabled = (stepIndex === 1);
        
        // Mise √† jour barre de progression
        const progress = (stepIndex / (totalSteps + 1)) * 100;
        document.getElementById('cookingProgress').style.width = `${progress}%`;
        
        currentStep = stepIndex;
    }

    function changeStep(delta) {
        showStep(currentStep + delta);
    }

// --- GESTION DU PARTAGE ---
const recipeId = {{ recipe.id }};

function generateShareLink() {
    fetch(`/recipe/${recipeId}/share`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `action=generate&csrf_token={{ csrf_token() }}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('shareLinkInput').value = data.share_url;
            document.getElementById('shareInit').classList.add('d-none');
            document.getElementById('shareResult').classList.remove('d-none');
        }
    });
}

function copyShareLink() {
    const input = document.getElementById('shareLinkInput');
    navigator.clipboard.writeText(input.value).then(() => {
        const confirm = document.getElementById('copyConfirm');
        confirm.classList.remove('d-none');
        setTimeout(() => confirm.classList.add('d-none'), 2000);
    });
}

function revokeShareLink() {
    fetch(`/recipe/${recipeId}/share`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `action=revoke&csrf_token={{ csrf_token() }}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('shareInit').classList.remove('d-none');
            document.getElementById('shareResult').classList.add('d-none');
        }
    });
}
</script>
{% endblock %}