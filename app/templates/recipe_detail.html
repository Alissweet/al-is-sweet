{% extends "base.html" %}

{% block title %}{{ recipe.title }} - Al' is Sweet{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- 1. VUE PRINCIPALE : Épurée & Moderne -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Photo Hero Standardisée -->
            <div class="recipe-image-wrapper">
                {% if recipe.image_filename %}
					{% if recipe.image_filename.startswith('http') %}
						<img src="{{ recipe.image_filename }}" alt="{{ recipe.title }}" class="recipe-hero-image">
					{% else %}
						<img src="{{ url_for('static', filename='uploads/' + recipe.image_filename) }}" alt="{{ recipe.title }}" class="recipe-hero-image">
					{% endif %}
				{% else %}
					<div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
						<i class="bi bi-camera display-1 opacity-25"></i>
					</div>
				{% endif %}
                
                <!-- Badge Glucides Flottant (Toujours par dessus) -->
                <div class="badge-carbs" style="top: 20px; right: 20px; font-size: 1rem; padding: 8px 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <i class="bi bi-lightning-fill text-warning"></i>
                    {{ "%.0f"|format(recipe.total_carbs) }}g <span class="fw-light ms-1 small opacity-75">totaux</span>
                </div>
            </div>

            <!-- Titre & Infos -->
            <div class="text-center mb-5">
                <span class="text-uppercase text-muted small ls-2 fw-bold">{{ recipe.category or 'Recette' }}</span>
                <h1 class="recipe-main-title">{{ recipe.title }}</h1>
                
                <!-- Méta Données -->
                <div class="d-flex justify-content-center gap-4 text-muted fw-medium">
                    <span><i class="bi bi-clock text-terracotta"></i> {{ recipe.total_time }} min</span>
                    <span><i class="bi bi-people text-terracotta"></i> <span id="servingsDisplay">{{ recipe.servings }}</span> pers.</span>
                    <span><i class="bi bi-bar-chart text-terracotta"></i> {{ recipe.difficulty }}</span>
                </div>
                
                {% if recipe.description %}
                <p class="mt-3 text-muted fst-italic">"{{ recipe.description }}"</p>
                {% endif %}
            </div>

            <!-- GRILLE D'ACTION (Le coeur de l'UX) -->
            <div class="action-grid">
                <!-- Bouton Liste de Courses -->
                <button class="btn-action-big btn-shopping" data-bs-toggle="modal" data-bs-target="#shoppingModal">
                    <i class="bi bi-basket3"></i>
                    <span>Liste de courses</span>
                </button>
                
                <!-- Bouton Let's Cook -->
                <button class="btn-action-big btn-cook" onclick="startCooking()">
                    <i class="bi bi-play-circle-fill"></i>
                    <span>Let's Cook !</span>
                </button>
            </div>

            <!-- Actions Admin (Discrètes en bas) -->
            <div class="text-center mt-5 pt-4 border-top">
                <a href="{{ url_for('main.recipe_edit', id=recipe.id) }}" class="text-muted small me-3 text-decoration-none">
                    <i class="bi bi-pencil"></i> Modifier
                </a>
                <a href="#" class="text-danger small text-decoration-none" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> Supprimer
                </a>
            </div>

        </div>
    </div>
</div>

<!-- 2. MODALE LISTE DE COURSES -->
<div class="modal fade" id="shoppingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-terracotta text-white">
                <h5 class="modal-title"><i class="bi bi-basket2 me-2"></i>Ingrédients</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Calculateur -->
                <div class="d-flex justify-content-between align-items-center mb-4 bg-light p-2 rounded-pill">
                    <span class="ms-3 text-muted small">Portions :</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-white rounded-circle shadow-sm" onclick="adjustServings(-1)"><i class="bi bi-dash"></i></button>
                        <span class="px-3 fw-bold d-flex align-items-center" id="modalServings">{{ recipe.servings }}</span>
                        <button class="btn btn-sm btn-white rounded-circle shadow-sm" onclick="adjustServings(1)"><i class="bi bi-plus"></i></button>
                    </div>
                </div>

                <!-- Liste à cocher -->
                <div class="list-group list-group-flush">
                    {% for ing in recipe.ingredients %}
                    <label class="list-group-item d-flex gap-3 align-items-center cursor-pointer">
                        <input class="form-check-input flex-shrink-0" type="checkbox" style="width: 1.5em; height: 1.5em;">
                        <span class="ingredient-text" data-base-qty="{{ ing.quantity or 0 }}">
                            <strong class="qty-display">{{ ing.quantity or '' }}</strong> 
                            {{ ing.unit or '' }} {{ ing.name }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer justify-content-center bg-light">
                <small class="text-muted">Cochez les éléments que vous avez déjà !</small>
            </div>
        </div>
    </div>
</div>

<!-- 3. OVERLAY MODE CUISINE (Caché par défaut) -->
<div id="cookingMode" class="d-none">
    <!-- Header Cuisine -->
    <div class="cooking-header">
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-fire text-terracotta fs-4"></i>
            <span class="fw-bold text-choco">Mode Cuisine</span>
        </div>
        <button class="btn btn-outline-secondary rounded-pill px-3" onclick="stopCooking()">
            <i class="bi bi-x-lg me-2"></i>Quitter
        </button>
    </div>

    <!-- Barre de progression -->
    <div class="progress-bar-custom">
        <div class="progress-fill" id="cookingProgress"></div>
    </div>

    <!-- Conteneur des étapes -->
    <div id="stepsContainer" class="flex-grow-1 d-flex flex-column">
        {% for step in recipe.steps.order_by('order') %}
        <div class="step-slide d-none" data-step="{{ loop.index }}">
            <div class="step-card h-100">
                <div class="step-number-big">Étape {{ loop.index }}</div>
                <p class="step-instruction-big">{{ step.instruction }}</p>
                {% if step.duration %}
                <div class="mt-4 text-muted">
                    <i class="bi bi-stopwatch fs-3 d-block mb-1"></i>
                    <span class="fs-5">{{ step.duration }} min</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Slide de Fin -->
        <div class="step-slide d-none" data-step="finish">
            <div class="step-card h-100 border-success border-2">
                <div class="step-number-big text-success">Bravo !</div>
                <p class="step-instruction-big">Votre recette est prête à être dégustée.</p>
                <i class="bi bi-emoji-heart-eyes display-1 text-warning mt-4"></i>
            </div>
        </div>
    </div>

    <!-- Contrôles de Navigation & Astuces -->
    <div class="cooking-controls">
        
        <!-- Wrapper Mobile -->
        <div class="mobile-btn-group d-contents-lg">
            <!-- Bouton Précédent (Cercle/Pilule gris) -->
            <button class="btn btn-outline-secondary btn-lg rounded-pill px-4" 
                    id="prevBtn" onclick="changeStep(-1)" disabled>
                <i class="bi bi-arrow-left"></i>
            </button>
            
            <!-- Bouton Suivant Mobile (Même style que Précédent) -->
            <button class="btn btn-outline-secondary btn-lg rounded-pill px-4 d-lg-none" 
                    id="nextBtnMobile" onclick="changeStep(1)">
                <i class="bi bi-arrow-right"></i>
            </button>
        </div>

        <!-- BOITE ASTUCE DU CHEF -->
        {% if recipe.tips %}
        <div class="chef-tip-box">
            <svg class="chef-hat-watermark" viewBox="0 0 24 24">
                <path d="M18,10h-1c-0.55,0-1-0.45-1-1c0-2.76-2.24-5-5-5S6,6.24,6,9c0,0.55-0.45,1-1,1H4c-1.1,0-2,0.9-2,2v7c0,1.1,0.9,2,2,2h16
                c1.1,0,2-0.9,2-2v-7C22,10.9,21.1,10,18,10z M18,4.5c0-0.64-0.31-1.22-0.79-1.6C16.4,2.32,15.25,2,14,2c-0.24,0-0.48,0.01-0.71,0.04
                C12.96,0.84,11.56,0,10,0C7.24,0,5,2.24,5,5c0,0.18,0.01,0.35,0.03,0.52C3.86,6.15,3,7.47,3,9h2C5,6.24,7.24,4,10,4
                c2.41,0,4.43,1.72,4.9,4h1.15C16.54,6.27,18,4.9,18,4.5z"/>
            </svg>
            <div class="chef-tip-title">
                <i class="bi bi-lightbulb-fill"></i> Le conseil du Chef
            </div>
            <p class="chef-tip-text">
                {{ recipe.tips }}
            </p>
        </div>
        {% else %}
        <div></div>
        {% endif %}

        <!-- Bouton Suivant Desktop (Même style que Précédent) -->
        <button class="btn btn-outline-secondary btn-lg rounded-pill px-4 d-none d-lg-block" 
                id="nextBtnDesktop" onclick="changeStep(1)">
            <i class="bi bi-arrow-right"></i>
        </button>

    </div>
</div>

<!-- Modal Suppression (Classique) -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <h5 class="mb-3">Supprimer cette recette ?</h5>
                <form action="{{ url_for('main.recipe_delete', id=recipe.id) }}" method="POST">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-danger">Oui, supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- GESTION DES PORTIONS (LISTE DE COURSES) ---
    const baseServings = {{ recipe.servings }};
    let currentServings = baseServings;

    function adjustServings(delta) {
        let newServings = currentServings + delta;
        if (newServings < 1) return;
        
        currentServings = newServings;
        // Mise à jour affichage principal et modal
        document.getElementById('servingsDisplay').textContent = currentServings;
        document.getElementById('modalServings').textContent = currentServings;
        
        const ratio = currentServings / baseServings;
        
        // Mise à jour des quantités dans la liste
        document.querySelectorAll('.ingredient-text').forEach(item => {
            const baseQty = parseFloat(item.dataset.baseQty);
            if (baseQty > 0) {
                const qtyElement = item.querySelector('.qty-display');
                let val = baseQty * ratio;
                // Formatage intelligent (pas de .0)
                qtyElement.textContent = Number.isInteger(val) ? val : val.toFixed(1);
            }
        });
    }

    // --- GESTION DU MODE CUISINE (WIZARD) ---
    let currentStep = 1;
    const totalSteps = {{ recipe.steps.count() }};
    
    function startCooking() {
        document.getElementById('cookingMode').classList.remove('d-none');
        document.body.style.overflow = 'hidden'; // Empêche le scroll de la page derrière
        showStep(1);
    }

    function stopCooking() {
        document.getElementById('cookingMode').classList.add('d-none');
        document.body.style.overflow = 'auto';
    }

    function showStep(stepIndex) {
        // Masquer toutes les slides
        document.querySelectorAll('.step-slide').forEach(el => el.classList.add('d-none'));
        
        // Afficher la slide courante
        let activeSlide;
        const nextBtns = [document.getElementById('nextBtnDesktop'), document.getElementById('nextBtnMobile')];
        
        if (stepIndex > totalSteps) {
            // Écran de fin
            activeSlide = document.querySelector('.step-slide[data-step="finish"]');
            
            nextBtns.forEach(btn => {
                if(btn) {
                    // On change juste l'icône pour une coche verte
                    btn.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                    btn.onclick = stopCooking;
                    // Optionnel : on peut colorer la bordure en vert pour marquer la fin
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-success');
                }
            });
        } else {
            // Étape normale
            activeSlide = document.querySelector(`.step-slide[data-step="${stepIndex}"]`);
            
            nextBtns.forEach(btn => {
                if(btn) {
                    // On remet la flèche standard
                    btn.innerHTML = '<i class="bi bi-arrow-right"></i>';
                    btn.onclick = () => changeStep(1);
                    // On remet le style gris standard
                    btn.classList.add('btn-outline-secondary');
                    btn.classList.remove('btn-outline-success');
                }
            });
        }
        
        if(activeSlide) activeSlide.classList.remove('d-none');

        // Mise à jour bouton Précédent
        const prevBtn = document.getElementById('prevBtn');
        if(prevBtn) prevBtn.disabled = (stepIndex === 1);
        
        // Mise à jour barre de progression
        const progress = (stepIndex / (totalSteps + 1)) * 100;
        document.getElementById('cookingProgress').style.width = `${progress}%`;
        
        currentStep = stepIndex;
    }

    function changeStep(delta) {
        showStep(currentStep + delta);
    }
</script>
{% endblock %}