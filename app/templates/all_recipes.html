{% extends "base.html" %}

{% block title %}Toutes mes recettes - Al' is Sweet{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- En-t√™te avec actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="font-playfair text-choco-dark mb-2">
                <i class="bi bi-journal-text me-2"></i>Toutes mes recettes
            </h1>
            <p class="text-muted">{{ recipe_data|length }} recette(s) au total</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-terracotta me-2" onclick="window.print()">
                <i class="bi bi-printer"></i> Imprimer
            </button>
            <button class="btn btn-terracotta" onclick="exportToPDF()">
                <i class="bi bi-file-pdf"></i> Export PDF
            </button>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">Rechercher</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Nom de recette...">
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Famille</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">Toutes les familles</option>
                        {% for cat in categories %}
                        <option value="{{ cat.name }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Difficult√©</label>
                    <select id="difficultyFilter" class="form-select">
                        <option value="">Toutes</option>
                        <option value="Facile">Facile</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Difficile">Difficile</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- BARRE FLOTTANTE LISTE DE COURSES -->
    <div id="shoppingBar" class="shopping-bar d-none">
        <div class="shopping-bar-inner">
            <div class="shopping-bar-info">
                <i class="bi bi-basket3-fill"></i>
                <span id="shoppingBarCount">0</span> recette(s) s√©lectionn√©e(s)
            </div>
            <div class="shopping-bar-actions">
                <button class="shopping-bar-btn-cancel" onclick="clearSelection()">
                    <i class="bi bi-x"></i> Annuler
                </button>
                <button class="shopping-bar-btn-go" onclick="goToShoppingList()">
                    <i class="bi bi-list-check"></i> G√©n√©rer la liste de courses
                </button>
            </div>
        </div>
    </div>

    <!-- Tableau des recettes -->
    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="recipesTable">
                <thead class="bg-terracotta text-white">
                    <tr>
                        <th style="width: 44px;">
                            <input type="checkbox" class="table-check-all" onchange="toggleAllRows(this)" title="Tout s√©lectionner">
                        </th>
                        <th class="sortable" data-column="image" style="width: 100px;">Photo</th>
                        <th class="sortable" data-column="title" style="cursor: pointer;">
                            Recette <i class="bi bi-chevron-expand ms-1"></i>
                        </th>
                        <th class="sortable" data-column="category" style="cursor: pointer;">
                            Famille <i class="bi bi-chevron-expand ms-1"></i>
                        </th>
                        <th class="sortable" data-column="ingredients" style="cursor: pointer;">
                            Ingr√©dients <i class="bi bi-chevron-expand ms-1"></i>
                        </th>
                        <th class="sortable text-center" data-column="time" style="cursor: pointer; width: 120px;">
                            Temps <i class="bi bi-chevron-expand ms-1"></i>
                        </th>
                        <th class="sortable text-center" data-column="carbs" style="cursor: pointer; width: 120px;">
                            Glucides <i class="bi bi-chevron-expand ms-1"></i>
                        </th>
						<th class="text-center sortable" data-column="rating" style="cursor: pointer; width: 130px;">
							Avis <i class="bi bi-chevron-expand ms-1"></i>
						</th>
                        <th class="text-center" style="width: 130px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recipe in recipe_data %}
                    <tr data-category="{{ recipe.category }}" data-difficulty="{{ recipe.difficulty }}" data-recipe-id="{{ recipe.id }}">
                        <td>
                            <input type="checkbox" class="row-check" 
                                   onchange="toggleRecipeSelect({{ recipe.id }}, this)"
                                   onclick="event.stopPropagation()">
                        </td>
                        <!-- Photo -->
                        <td>
                            {% if recipe.image %}
                                {% if recipe.image.startswith('http') %}
                                    <div class="img-preview-wrapper">
                                        <img src="{{ recipe.image }}" alt="{{ recipe.title }}" 
                                             class="rounded shadow-sm img-thumb">
                                        <div class="img-preview-zoom">
                                            <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="img-preview-wrapper">
                                        <img src="{{ url_for('static', filename='uploads/' + recipe.image) }}" alt="{{ recipe.title }}" 
                                             class="rounded shadow-sm img-thumb">
                                        <div class="img-preview-zoom">
                                            <img src="{{ url_for('static', filename='uploads/' + recipe.image) }}" alt="{{ recipe.title }}">
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="img-placeholder img-placeholder-thumb">
                                    <div class="img-placeholder-inner">
                                        <i class="bi bi-egg-fried"></i>
                                    </div>
                                </div>
                            {% endif %}
                        </td>
                        
                        <!-- Titre -->
                        <td>
                            <div class="fw-bold text-choco">{{ recipe.title }}</div>
                            <small class="text-muted">
                                <i class="bi bi-people"></i> {{ recipe.servings }} pers. 
                                <span class="ms-2">
                                    {% if recipe.difficulty == 'Facile' %}
                                        <span class="badge bg-success">{{ recipe.difficulty }}</span>
                                    {% elif recipe.difficulty == 'Moyen' %}
                                        <span class="badge bg-warning text-dark">{{ recipe.difficulty }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ recipe.difficulty }}</span>
                                    {% endif %}
                                </span>
                            </small>
                        </td>
                        
                        <!-- Cat√©gorie -->
                        <td>
                            <span class="badge bg-terracotta-light text-choco-dark">
                                {{ recipe.category }}
                            </span>
                        </td>
                        
                        <!-- Ingr√©dients -->
                        <td>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#ingredients-{{ recipe.id }}">
                                <i class="bi bi-basket2"></i> {{ recipe.ingredients|length }} ingr√©dient(s)
                            </button>
                            <div class="collapse mt-2" id="ingredients-{{ recipe.id }}">
                                <ul class="list-unstyled small mb-0">
                                    {% for ing in recipe.ingredients[:5] %}
                                    <li><i class="bi bi-dot"></i> {{ ing }}</li>
                                    {% endfor %}
                                    {% if recipe.ingredients|length > 5 %}
                                    <li class="text-muted fst-italic">+ {{ recipe.ingredients|length - 5 }} autre(s)...</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                        
                        <!-- Temps total -->
                        <td class="text-center">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-clock"></i> {{ recipe.total_time }} min
                            </span>
                        </td>
                        
                        <!-- Glucides -->
                        <td class="text-center">
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-lightning-fill"></i> {{ recipe.total_carbs }}g
                            </span>
                        </td>
						
						<!-- Notation -->
						<td class="text-center">
							{% if recipe.rating %}
								{% set emojis = {1: 'üòï', 2: 'üòê', 3: 'üôÇ', 4: 'üòä', 5: 'ü§©'} %}
								{% set labels = {1: '√Ä revoir', 2: 'Bof‚Ä¶', 3: 'Bien', 4: 'Tr√®s bien', 5: 'Incontournable'} %}
								{% set colors = {1: '#e57373', 2: '#ffb74d', 3: '#c59d85', 4: '#66bb6a', 5: '#ffd54f'} %}
								<span style="
									display: inline-flex; align-items: center; gap: 5px;
									background: {{ colors[recipe.rating] }}22;
									border: 1.5px solid {{ colors[recipe.rating] }};
									border-radius: 50px; padding: 3px 10px;
									font-size: 0.78rem; font-weight: 600;
									color: #3e2723;">
									{{ emojis[recipe.rating] }} {{ labels[recipe.rating] }}
								</span>
							{% else %}
								<span class="text-muted small fst-italic">‚Äî</span>
							{% endif %}
						</td>
                        
                        <!-- Actions -->
						<td class="text-center" style="white-space: nowrap;">
							<a href="{{ url_for('main.recipe_detail', id=recipe.id) }}" 
							   class="btn btn-sm btn-outline-primary me-1" 
							   title="Voir">
								<i class="bi bi-eye"></i>
							</a>
							<a href="{{ url_for('main.recipe_edit', id=recipe.id) }}" 
							   class="btn btn-sm btn-outline-secondary me-1" 
							   title="Modifier">
								<i class="bi bi-pencil"></i>
							</a>
							<a href="{{ url_for('main.recipe_pdf', id=recipe.id) }}" 
							   class="btn btn-sm btn-outline-danger" 
							   title="T√©l√©charger PDF"
							   target="_blank">
								<i class="bi bi-file-earmark-pdf"></i>
							</a>
						</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Message si vide -->
    {% if not recipe_data %}
    <div class="text-center py-5">
        <i class="bi bi-journal-x display-1 text-muted"></i>
        <p class="lead text-muted mt-3">Aucune recette pour le moment</p>
        <a href="{{ url_for('main.recipe_new') }}" class="btn btn-terracotta">
            <i class="bi bi-plus-circle"></i> Cr√©er ma premi√®re recette
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    // Filtrage en temps r√©el
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const difficultyFilter = document.getElementById('difficultyFilter');
    const tableRows = document.querySelectorAll('#recipesTable tbody tr');

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const difficultyValue = difficultyFilter.value;

        tableRows.forEach(row => {
            const title = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const category = row.dataset.category;
            const difficulty = row.dataset.difficulty;

            const matchSearch = title.includes(searchTerm);
            const matchCategory = !categoryValue || category === categoryValue;
            const matchDifficulty = !difficultyValue || difficulty === difficultyValue;

            if (matchSearch && matchCategory && matchDifficulty) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterTable);
    categoryFilter.addEventListener('change', filterTable);
    difficultyFilter.addEventListener('change', filterTable);

    // Tri des colonnes
    let sortDirection = {};
    document.querySelectorAll('.sortable').forEach(header => {
        sortDirection[header.dataset.column] = 1;
        
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            const tbody = document.querySelector('#recipesTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal, bVal;

                switch(column) {
                    case 'time':
						aVal = parseInt(a.querySelector('td:nth-child(6)').textContent.match(/\d+/)[0]);
						bVal = parseInt(b.querySelector('td:nth-child(6)').textContent.match(/\d+/)[0]);
						break;
                    case 'category':
                        aVal = a.dataset.category;
                        bVal = b.dataset.category;
                        break;
                    case 'time':
                        aVal = parseInt(a.querySelector('td:nth-child(5)').textContent.match(/\d+/)[0]);
                        bVal = parseInt(b.querySelector('td:nth-child(5)').textContent.match(/\d+/)[0]);
                        break;
                    case 'carbs':
						aVal = parseInt(a.querySelector('td:nth-child(7)').textContent.match(/\d+/)[0]);
						bVal = parseInt(b.querySelector('td:nth-child(7)').textContent.match(/\d+/)[0]);
						break;
                    case 'ingredients':
                        aVal = a.querySelector('td:nth-child(4)').textContent.match(/\d+/)[0];
                        bVal = b.querySelector('td:nth-child(4)').textContent.match(/\d+/)[0];
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return sortDirection[column] * aVal.localeCompare(bVal);
                } else {
                    return sortDirection[column] * (aVal - bVal);
                }
            });

            sortDirection[column] *= -1;
            rows.forEach(row => tbody.appendChild(row));

            // Mise √† jour de l'ic√¥ne
            document.querySelectorAll('.sortable i').forEach(i => i.className = 'bi bi-chevron-expand ms-1');
            this.querySelector('i').className = sortDirection[column] === 1 ? 'bi bi-chevron-down ms-1' : 'bi bi-chevron-up ms-1';
        });
    });

	// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
	//  EXPORT PDF ‚Äî Al' is Sweet
	//  Remplace la fonction exportToPDF() dans all_recipes.html
	//  D√©pendances d√©j√† pr√©sentes : jsPDF 2.5.1 + jsPDF-AutoTable 3.5.31
	// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

	function exportToPDF() {
		const { jsPDF } = window.jspdf;
		const doc = new jsPDF('p', 'mm', 'a4');
		const pageW = doc.internal.pageSize.getWidth();   // 210
		const pageH = doc.internal.pageSize.getHeight();  // 297
		const margin = 14;
		const contentW = pageW - margin * 2;

		// ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const TERRACOTTA   = [197, 157, 133];
		const TERRACOTTA_D = [160, 120,  88];
		const CHOCO        = [ 62,  39,  35];
		const CHOCO_L      = [109,  76,  65];
		const CREAM        = [253, 246, 240];
		const CREAM_D      = [245, 233, 219];
		const GOLD         = [212, 168,  71];
		const MUTED        = [141, 110,  99];
		const WHITE        = [255, 255, 255];
		const BORDER       = [220, 200, 185];
		const SUCCESS_BG   = [232, 245, 232];
		const SUCCESS_FG   = [ 46, 125,  50];
		const WARNING_BG   = [255, 243, 220];
		const WARNING_FG   = [200,  90,   0];
		const DANGER_BG    = [252, 228, 236];
		const DANGER_FG    = [198,  40,  40];
		const INCONTOUR_BG = [255, 253, 210];
		const INCONTOUR_FG = [160, 110,   0];

		// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const sf = (rgb) => doc.setFillColor(...rgb);
		const sd = (rgb) => doc.setDrawColor(...rgb);
		const st = (rgb) => doc.setTextColor(...rgb);
		const ss = (pt)  => doc.setFontSize(pt);
		const bold   = () => doc.setFont('helvetica', 'bold');
		const normal = () => doc.setFont('helvetica', 'normal');
		const italic = () => doc.setFont('helvetica', 'italic');
		const rr = (x, y, w, h, r, style) => doc.roundedRect(x, y, w, h, r, r, style);

		// ‚îÄ‚îÄ COLLECTE DES DONN√âES VISIBLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const rows = [];
		document.querySelectorAll('#recipesTable tbody tr').forEach(row => {
			if (row.style.display === 'none') return;
			const cells = row.querySelectorAll('td');

			const titleEl    = cells[2]?.querySelector('.fw-bold');
			const diffEl     = cells[2]?.querySelector('.badge');
			const catEl      = cells[3]?.querySelector('.badge');
			const timeEl     = cells[5];
			const carbsEl    = cells[6];
			const ratingEl   = cells[7];
			const ingEl      = cells[4];

			const timeMatch  = timeEl?.textContent.match(/\d+/);
			const carbsMatch = carbsEl?.textContent.match(/[\d.]+/);
			const ratingSpan = ratingEl?.querySelector('span:not(.text-muted)');
			const ratingText = ratingSpan?.textContent.trim() || '';
			const ingMatch   = ingEl?.textContent.match(/(\d+)/);
			const servMatch  = cells[2]?.textContent.match(/(\d+)\s*pers/);

			rows.push({
				title:       titleEl?.textContent.trim()  || '‚Äî',
				difficulty:  diffEl?.textContent.trim()   || '',
				category:    catEl?.textContent.trim()    || '‚Äî',
				time:        timeMatch  ? parseInt(timeMatch[0])    : null,
				carbs:       carbsMatch ? parseFloat(carbsMatch[0]) : null,
				rating:      ratingText,
				servings:    servMatch  ? parseInt(servMatch[1])    : null,
				ingredients: ingMatch   ? parseInt(ingMatch[0])     : null,
			});
		});

		const dateStr = new Date().toLocaleDateString('fr-FR', {
			year: 'numeric', month: 'long', day: 'numeric'
		});

		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		//  PAGE 1 : COUVERTURE
		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

		// Fond pleine page chocolat
		sf(CHOCO);
		doc.rect(0, 0, pageW, pageH, 'F');

		// Cercles d√©coratifs discrets
		sf([80, 50, 45]);
		doc.circle(pageW + 10, -10, 70, 'F');
		sf([75, 46, 42]);
		doc.circle(-15, pageH + 10, 55, 'F');

		// ‚îÄ‚îÄ Titre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		st(WHITE);
		ss(34);
		bold();
		doc.text("Al' is Sweet", pageW / 2, 70, { align: 'center' });

		// Sous-titre en TERRACOTTA (visible sur fond chocolat)
		st(TERRACOTTA);
		ss(12);
		normal();
		doc.text('Mon carnet de recettes', pageW / 2, 84, { align: 'center' });

		// Ligne dor√©e
		sd(GOLD);
		doc.setLineWidth(0.8);
		doc.line(pageW / 2 - 35, 91, pageW / 2 + 35, 91);

		// ‚îÄ‚îÄ Grand chiffre centr√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		// Positionn√© largement en dessous du titre pour √©viter tout chevauchement
		st(WHITE);
		ss(80);
		bold();
		doc.text(String(rows.length), pageW / 2, 165, { align: 'center' });

		// "recette(s)" en dessous du chiffre, espac√©
		st(TERRACOTTA);
		ss(15);
		normal();
		doc.text('recette' + (rows.length > 1 ? 's' : ''), pageW / 2, 183, { align: 'center' });

		// Stats secondaires encore en dessous
		const validTimes  = rows.filter(r => r.time).map(r => r.time);
		const avgTime     = validTimes.length
			? Math.round(validTimes.reduce((a, b) => a + b, 0) / validTimes.length)
			: null;
		const categories  = [...new Set(rows.map(r => r.category).filter(c => c && c !== '‚Äî'))];
		const statParts   = [];
		if (avgTime)           statParts.push(`Temps moyen : ${avgTime} min`);
		if (categories.length) statParts.push(`${categories.length} famille${categories.length > 1 ? 's' : ''}`);

		if (statParts.length) {
			st([180, 150, 135]);
			ss(8.5);
			italic();
			doc.text(statParts.join('   ¬∑   '), pageW / 2, 196, { align: 'center' });
		}

		// ‚îÄ‚îÄ Bande terracotta en bas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		sf(TERRACOTTA);
		doc.rect(0, pageH - 55, pageW, 55, 'F');

		sd(GOLD);
		doc.setLineWidth(1);
		doc.line(0, pageH - 55, pageW, pageH - 55);

		st(CHOCO);
		ss(15);
		bold();
		doc.text('Catalogue complet', pageW / 2, pageH - 32, { align: 'center' });

		st(CHOCO);
		ss(9);
		normal();
		doc.text(`G√©n√©r√© le ${dateStr}`, pageW / 2, pageH - 20, { align: 'center' });

		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		//  FONCTIONS EN-T√äTE / PIED DE PAGE
		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

		function drawPageHeader() {
			sf(CHOCO);
			doc.rect(0, 0, pageW, 20, 'F');
			st(WHITE);
			ss(11);
			bold();
			doc.text("Al' is Sweet", margin, 13);
			st(TERRACOTTA);
			ss(8);
			normal();
			doc.text('‚Äî Mon carnet de recettes', margin + 28, 13);
			st([180, 160, 150]);
			ss(7);
			doc.text(dateStr, pageW - margin, 13, { align: 'right' });
			sd(GOLD);
			doc.setLineWidth(0.5);
			doc.line(0, 20, pageW, 20);
		}

		function drawPageFooter(pageNum, totalPages) {
			sf(CHOCO);
			doc.rect(0, pageH - 11, pageW, 11, 'F');
			st([180, 160, 150]);
			ss(7);
			normal();
			doc.text("Al' is Sweet ‚Äî Mon carnet de recettes", margin, pageH - 4);
			doc.text(`${pageNum} / ${totalPages}`, pageW - margin, pageH - 4, { align: 'right' });
		}

		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		//  PAGE 2+ : TABLEAU
		// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
		doc.addPage();
		drawPageHeader();

		let curY = 28;

		// Titre + compteur
		st(CHOCO);
		ss(15);
		bold();
		doc.text('Toutes mes recettes', margin, curY);
		curY += 7;

		const activeFilters = [];
		const searchVal = document.getElementById('searchInput')?.value?.trim();
		const catVal    = document.getElementById('categoryFilter')?.value;
		const diffVal   = document.getElementById('difficultyFilter')?.value;
		if (searchVal) activeFilters.push(`Recherche : "${searchVal}"`);
		if (catVal)    activeFilters.push(`Famille : ${catVal}`);
		if (diffVal)   activeFilters.push(`Difficult√© : ${diffVal}`);

		st(MUTED);
		ss(8);
		if (activeFilters.length) {
			italic();
			doc.text('Filtres actifs : ' + activeFilters.join(' ¬∑ '), margin, curY);
		} else {
			normal();
			doc.text(`${rows.length} recette${rows.length > 1 ? 's' : ''} au total`, margin, curY);
		}
		curY += 8;

		// ‚îÄ‚îÄ Colonnes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		// Total = 182mm  ‚Üí  65 + 33 + 24 + 20 + 20 + 20 = 182 ‚úì
		const COL = [
			{ label: 'Recette',    w: 65, align: 'left'   },
			{ label: 'Famille',    w: 33, align: 'center' },
			{ label: 'Difficult√©', w: 24, align: 'center' },
			{ label: 'Temps',      w: 20, align: 'center' },
			{ label: 'Glucides',   w: 20, align: 'center' },
			{ label: 'Avis',       w: 20, align: 'center' },
		];
		COL[0].x = margin;
		for (let i = 1; i < COL.length; i++) COL[i].x = COL[i-1].x + COL[i-1].w;

		const ROW_H  = 17;   // Hauteur augment√©e pour accueillir 2 lignes de titre
		const HEAD_H = 10;

		function drawTableHead(y) {
			sf(CHOCO);
			doc.rect(margin, y, contentW, HEAD_H, 'F');
			COL.forEach(col => {
				st(WHITE);
				ss(7.5);
				bold();
				const tx = col.align === 'center' ? col.x + col.w / 2 : col.x + 3;
				doc.text(col.label, tx, y + 6.8, { align: col.align });
			});
			return y + HEAD_H;
		}

		curY = drawTableHead(curY);

		// ‚îÄ‚îÄ Helpers badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		function drawBadge(text, colX, colW, rowY, rowH, bgColor, fgColor, fontSize) {
			ss(fontSize);
			doc.setFont('helvetica', 'normal'); // reset avant mesure
			const textW = doc.getTextWidth(text);
			const badgeW = Math.min(colW - 4, Math.max(textW + 6, 14));
			const bx = colX + (colW - badgeW) / 2;
			const by = rowY + (rowH - 5.5) / 2;
			sf(bgColor);
			sd(fgColor);
			doc.setLineWidth(0.35);
			rr(bx, by, badgeW, 5.5, 1.5, 'FD');
			st(fgColor);
			bold();
			doc.text(text, colX + colW / 2, rowY + rowH / 2 + 1.2, { align: 'center' });
		}

		function diffColors(d) {
			if (d === 'Facile')    return { bg: SUCCESS_BG, fg: SUCCESS_FG };
			if (d === 'Difficile') return { bg: DANGER_BG,  fg: DANGER_FG  };
			return { bg: WARNING_BG, fg: WARNING_FG };
		}

		function ratingColors(txt) {
			if (!txt) return null;
			const t = txt.toLowerCase();
			if (t.includes('incontournable'))               return { bg: INCONTOUR_BG, fg: INCONTOUR_FG };
			if (t.includes('tr√®s bien'))                    return { bg: SUCCESS_BG,   fg: SUCCESS_FG   };
			if (t.includes('bien') && !t.includes('tr√®s'))  return { bg: [225, 240, 255], fg: [30, 100, 190] };
			if (t.includes('bof'))                          return { bg: WARNING_BG,   fg: WARNING_FG   };
			if (t.includes('revoir'))                       return { bg: DANGER_BG,    fg: DANGER_FG    };
			return null;
		}

		// ‚îÄ‚îÄ Lignes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		rows.forEach((r, idx) => {
			// Saut de page si besoin
			if (curY + ROW_H > pageH - 18) {
				doc.addPage();
				drawPageHeader();
				curY = 26;
				curY = drawTableHead(curY);
			}

			// Fond altern√©
			sf(idx % 2 === 0 ? WHITE : CREAM);
			doc.rect(margin, curY, contentW, ROW_H, 'F');

			// S√©parateur bas
			sd(BORDER);
			doc.setLineWidth(0.15);
			doc.line(margin, curY + ROW_H, margin + contentW, curY + ROW_H);

			const midY = curY + ROW_H / 2;

			// Col 0 ‚Äî Titre sur 2 lignes max + sous-texte
			st(CHOCO);
			ss(8.5);
			bold();
			// splitTextToSize coupe proprement sur la largeur disponible
			const titleLines = doc.splitTextToSize(r.title, COL[0].w - 6);
			const maxLines   = 2;
			const displayed  = titleLines.slice(0, maxLines);
			// Si le titre a √©t√© coup√© √† 2 lignes et qu'il y en avait plus, ajouter "‚Ä¶"
			if (titleLines.length > maxLines) {
				displayed[maxLines - 1] = displayed[maxLines - 1].replace(/\s?\S+$/, '') + '‚Ä¶';
			}
			// Positionnement vertical : centrer le bloc titre + sous-texte dans la ligne
			const lineH   = 4.5;  // interligne entre les 2 lignes de titre
			const subH    = 4.5;  // espace pour le sous-texte
			const blockH  = displayed.length * lineH + subH;
			const blockTop = curY + (ROW_H - blockH) / 2 + 1;
			displayed.forEach((line, i) => {
				doc.text(line, COL[0].x + 3, blockTop + i * lineH);
			});

			const sub = [
				r.ingredients !== null ? `${r.ingredients} ingr√©d.` : null,
				r.servings    !== null ? `${r.servings} pers.`       : null,
			].filter(Boolean).join('  ¬∑  ');
			if (sub) {
				st(MUTED);
				ss(6.5);
				normal();
				doc.text(sub, COL[0].x + 3, blockTop + displayed.length * lineH + 1.5);
			}

			// Col 1 ‚Äî Famille (taille police r√©duite pour que le texte complet rentre toujours)
			if (r.category && r.category !== '‚Äî') {
				// On r√©duit la police jusqu'√† ce que le texte rentre dans la colonne
				let catFontSize = 7;
				doc.setFont('helvetica', 'bold');
				ss(catFontSize);
				while (doc.getTextWidth(r.category) > COL[1].w - 6 && catFontSize > 4.5) {
					catFontSize -= 0.5;
					ss(catFontSize);
				}
				const measuredW = doc.getTextWidth(r.category);
				const catW = Math.min(COL[1].w - 2, measuredW + 6);
				const cx = COL[1].x + (COL[1].w - catW) / 2;
				const cy = curY + (ROW_H - 5.5) / 2;
				sf(CREAM_D);
				sd(BORDER);
				doc.setLineWidth(0.3);
				rr(cx, cy, catW, 5.5, 1.5, 'FD');
				st(CHOCO_L);
				// Centrage vertical ancr√© sur cy (haut du badge)
				doc.text(r.category, COL[1].x + COL[1].w / 2, cy + 5.5 / 2 + 1, { align: 'center' });
			}

			// Col 2 ‚Äî Difficult√©
			if (r.difficulty) {
				const dc = diffColors(r.difficulty);
				drawBadge(r.difficulty, COL[2].x, COL[2].w, curY, ROW_H, dc.bg, dc.fg, 6.5);
			}

			// Col 3 ‚Äî Temps
			if (r.time !== null) {
				st(CHOCO);
				ss(10);
				bold();
				doc.text(String(r.time), COL[3].x + COL[3].w / 2, curY + ROW_H / 2 - 0.5, { align: 'center' });
				st(MUTED);
				ss(6);
				normal();
				doc.text('min', COL[3].x + COL[3].w / 2, curY + ROW_H / 2 + 4.5, { align: 'center' });
			} else {
				st(MUTED); ss(8); normal();
				doc.text('‚Äî', COL[3].x + COL[3].w / 2, curY + ROW_H / 2 + 1, { align: 'center' });
			}

			// Col 4 ‚Äî Glucides
			if (r.carbs !== null) {
				st(TERRACOTTA_D);
				ss(10);
				bold();
				doc.text(String(Math.round(r.carbs)), COL[4].x + COL[4].w / 2, curY + ROW_H / 2 - 0.5, { align: 'center' });
				st(MUTED);
				ss(6);
				normal();
				doc.text('g', COL[4].x + COL[4].w / 2, curY + ROW_H / 2 + 4.5, { align: 'center' });
			} else {
				st(MUTED); ss(8); normal();
				doc.text('‚Äî', COL[4].x + COL[4].w / 2, curY + ROW_H / 2 + 1, { align: 'center' });
			}

			// Col 5 ‚Äî Avis (taille police r√©duite si texte long, ex: "Incontournable")
			const ratingClean = r.rating.replace(/[\u{1F300}-\u{1FFFF}\u2728]/gu, '').trim();
			if (ratingClean) {
				const rc = ratingColors(r.rating);
				if (rc) {
					// Calcul dynamique de la police pour que le texte rentre dans la colonne
					let rFontSize = 7;
					doc.setFont('helvetica', 'bold');
					ss(rFontSize);
					while (doc.getTextWidth(ratingClean) > COL[5].w - 6 && rFontSize > 4.5) {
						rFontSize -= 0.5;
						ss(rFontSize);
					}
					const rTextW  = doc.getTextWidth(ratingClean);
					const badgeW  = Math.min(COL[5].w - 2, rTextW + 6);
					const bx = COL[5].x + (COL[5].w - badgeW) / 2;
					const by = curY + (ROW_H - 5.5) / 2;
					sf(rc.bg);
					sd(rc.fg);
					doc.setLineWidth(0.35);
					rr(bx, by, badgeW, 5.5, 1.5, 'FD');
					st(rc.fg);
					// Centrage vertical : milieu du badge = by + 5.5/2, texte baseline = milieu + ~1
					doc.text(ratingClean, COL[5].x + COL[5].w / 2, by + 5.5 / 2 + 1, { align: 'center' });
				} else {
					st(MUTED); ss(7.5); normal();
					doc.text(ratingClean, COL[5].x + COL[5].w / 2, midY + 1, { align: 'center' });
				}
			} else {
				st(MUTED); ss(8); normal();
				doc.text('‚Äî', COL[5].x + COL[5].w / 2, midY + 1, { align: 'center' });
			}

			curY += ROW_H;
		});

		// ‚îÄ‚îÄ Pied de page sur toutes les pages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const total = doc.internal.getNumberOfPages();
		for (let p = 1; p <= total; p++) {
			doc.setPage(p);
			drawPageFooter(p, total);
		}

		// ‚îÄ‚îÄ Sauvegarde ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const filename = `Al-is-Sweet_recettes_${new Date().toISOString().slice(0, 10)}.pdf`;
		doc.save(filename);
	}
</script>
{% endblock %}